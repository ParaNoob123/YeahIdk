#!/bin/bash

clear
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo " ğŸŒ LXC Network Auto Fix - Para"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo ""

# Ask container name
read -p "ğŸ‘‰ Enter LXC Container Name: " CT_NAME

if ! lxc info "$CT_NAME" >/dev/null 2>&1; then
  echo ""
  echo "âŒ Container '$CT_NAME' not found"
  exit 1
fi

# Detect lxdbr0 subnet
LXD_SUBNET=$(lxc network get lxdbr0 ipv4.address | cut -d'/' -f1)/24

if [[ -z "$LXD_SUBNET" ]]; then
  echo "âŒ Could not detect lxdbr0 subnet"
  exit 1
fi

echo ""
echo "ğŸ“¡ Detected LXD subnet: $LXD_SUBNET"

echo ""
echo "ğŸ›  Enabling IP Forwarding..."
sysctl -w net.ipv4.ip_forward=1 >/dev/null
grep -q "net.ipv4.ip_forward=1" /etc/sysctl.conf || \
  echo "net.ipv4.ip_forward=1" >> /etc/sysctl.conf

echo "âœ… IP Forwarding enabled"

echo ""
echo "ğŸ”¥ Applying iptables rules..."

iptables -t nat -C POSTROUTING -s "$LXD_SUBNET" ! -d "$LXD_SUBNET" -j MASQUERADE 2>/dev/null || \
iptables -t nat -A POSTROUTING -s "$LXD_SUBNET" ! -d "$LXD_SUBNET" -j MASQUERADE

iptables -C FORWARD -i lxdbr0 -j ACCEPT 2>/dev/null || \
iptables -A FORWARD -i lxdbr0 -j ACCEPT

iptables -C FORWARD -o lxdbr0 -j ACCEPT 2>/dev/null || \
iptables -A FORWARD -o lxdbr0 -j ACCEPT

echo "âœ… Firewall rules applied"

echo ""
echo "ğŸ”„ Restarting container..."
lxc restart "$CT_NAME"

sleep 3

echo ""
echo "ğŸŒ Testing internet inside container..."
lxc exec "$CT_NAME" -- bash -c "ping -c 3 google.com"

echo ""
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo " âœ… LXC Network Fix Completed!"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo " ğŸ“¦ Container : $CT_NAME"
echo " ğŸŒ Subnet    : $LXD_SUBNET"
echo " ğŸ›  Check     : lxc exec $CT_NAME -- bash"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
